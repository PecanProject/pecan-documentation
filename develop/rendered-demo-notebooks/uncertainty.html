<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Aritra Dey">
<meta name="author" content="David LeBauer">

<title>Uncertainty Analysis Using PEcAn</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="uncertainty_files/libs/clipboard/clipboard.min.js"></script>
<script src="uncertainty_files/libs/quarto-html/quarto.js"></script>
<script src="uncertainty_files/libs/quarto-html/popper.min.js"></script>
<script src="uncertainty_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="uncertainty_files/libs/quarto-html/anchor.min.js"></script>
<link href="uncertainty_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="uncertainty_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="uncertainty_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="uncertainty_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="uncertainty_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites"><span class="header-section-number">1.1</span> Prerequisites</a>
  <ul class="collapse">
  <li><a href="#pecan-packages-and-dependencies." id="toc-pecan-packages-and-dependencies." class="nav-link" data-scroll-target="#pecan-packages-and-dependencies."><span class="header-section-number">1.1.1</span> PEcAn packages and dependencies.</a></li>
  <li><a href="#sipnet-v1.3.0" id="toc-sipnet-v1.3.0" class="nav-link" data-scroll-target="#sipnet-v1.3.0"><span class="header-section-number">1.1.2</span> SIPNET v1.3.0</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#load-pecan-packages" id="toc-load-pecan-packages" class="nav-link" data-scroll-target="#load-pecan-packages"><span class="header-section-number">2</span> Load PEcAn Packages</a></li>
  <li><a href="#load-pecan-settings-file" id="toc-load-pecan-settings-file" class="nav-link" data-scroll-target="#load-pecan-settings-file"><span class="header-section-number">3</span> Load PEcAn Settings File</a>
  <ul class="collapse">
  <li><a href="#settings" id="toc-settings" class="nav-link" data-scroll-target="#settings"><span class="header-section-number">3.1</span> Settings</a></li>
  <li><a href="#load-the-settings-file" id="toc-load-the-settings-file" class="nav-link" data-scroll-target="#load-the-settings-file"><span class="header-section-number">3.2</span> Load the settings file</a></li>
  </ul></li>
  <li><a href="#sec-write-configs" id="toc-sec-write-configs" class="nav-link" data-scroll-target="#sec-write-configs"><span class="header-section-number">4</span> Write Model Configuration Files</a></li>
  <li><a href="#run-model-simulations" id="toc-run-model-simulations" class="nav-link" data-scroll-target="#run-model-simulations"><span class="header-section-number">5</span> Run Model Simulations</a></li>
  <li><a href="#fetch-model-outputs" id="toc-fetch-model-outputs" class="nav-link" data-scroll-target="#fetch-model-outputs"><span class="header-section-number">6</span> Fetch Model Outputs</a></li>
  <li><a href="#sec-run-uncertainty" id="toc-sec-run-uncertainty" class="nav-link" data-scroll-target="#sec-run-uncertainty"><span class="header-section-number">7</span> Ensemble and Sensitivity Analysis</a></li>
  <li><a href="#sec-outputs" id="toc-sec-outputs" class="nav-link" data-scroll-target="#sec-outputs"><span class="header-section-number">8</span> PEcAn Outputs</a>
  <ul class="collapse">
  <li><a href="#output-directory-structure" id="toc-output-directory-structure" class="nav-link" data-scroll-target="#output-directory-structure"><span class="header-section-number">8.1</span> Output Directory Structure</a>
  <ul class="collapse">
  <li><a href="#model-outputs-and-logs" id="toc-model-outputs-and-logs" class="nav-link" data-scroll-target="#model-outputs-and-logs"><span class="header-section-number">8.1.1</span> Model outputs and logs</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#understanding-pecan-uncertainty-analysis-outputs" id="toc-understanding-pecan-uncertainty-analysis-outputs" class="nav-link" data-scroll-target="#understanding-pecan-uncertainty-analysis-outputs"><span class="header-section-number">9</span> Understanding PEcAn Uncertainty Analysis Outputs</a>
  <ul class="collapse">
  <li><a href="#ensemble-analysis-outputs" id="toc-ensemble-analysis-outputs" class="nav-link" data-scroll-target="#ensemble-analysis-outputs"><span class="header-section-number">9.1</span> Ensemble Analysis Outputs</a></li>
  <li><a href="#sensitivity-analysis-outputs" id="toc-sensitivity-analysis-outputs" class="nav-link" data-scroll-target="#sensitivity-analysis-outputs"><span class="header-section-number">9.2</span> Sensitivity Analysis Outputs</a></li>
  <li><a href="#variance-decomposition-outputs" id="toc-variance-decomposition-outputs" class="nav-link" data-scroll-target="#variance-decomposition-outputs"><span class="header-section-number">9.3</span> Variance Decomposition Outputs</a></li>
  <li><a href="#interpreting-the-results" id="toc-interpreting-the-results" class="nav-link" data-scroll-target="#interpreting-the-results"><span class="header-section-number">9.4</span> Interpreting the Results</a></li>
  </ul></li>
  <li><a href="#sec-visualize" id="toc-sec-visualize" class="nav-link" data-scroll-target="#sec-visualize"><span class="header-section-number">10</span> Visualize Uncertainty Analysis Results</a>
  <ul class="collapse">
  <li><a href="#ensemble-analysis-visualization" id="toc-ensemble-analysis-visualization" class="nav-link" data-scroll-target="#ensemble-analysis-visualization"><span class="header-section-number">10.1</span> Ensemble Analysis Visualization</a></li>
  <li><a href="#sensitivity-and-variance-decomposition-visualization" id="toc-sensitivity-and-variance-decomposition-visualization" class="nav-link" data-scroll-target="#sensitivity-and-variance-decomposition-visualization"><span class="header-section-number">10.2</span> Sensitivity and Variance Decomposition Visualization</a></li>
  </ul></li>
  <li><a href="#customizing-ensemble-analysis-parameters-optional" id="toc-customizing-ensemble-analysis-parameters-optional" class="nav-link" data-scroll-target="#customizing-ensemble-analysis-parameters-optional"><span class="header-section-number">11</span> Customizing Ensemble Analysis Parameters (Optional)</a>
  <ul class="collapse">
  <li><a href="#optional-use-this-section-only-if-you-want-to-override-the-default-ensemble-analysis-parameters.-skip-if-defaults-are-sufficient." id="toc-optional-use-this-section-only-if-you-want-to-override-the-default-ensemble-analysis-parameters.-skip-if-defaults-are-sufficient." class="nav-link" data-scroll-target="#optional-use-this-section-only-if-you-want-to-override-the-default-ensemble-analysis-parameters.-skip-if-defaults-are-sufficient."><span class="header-section-number">11.1</span> (Optional) Use this section only if you want to override the default ensemble analysis parameters. Skip if defaults are sufficient.</a></li>
  </ul></li>
  <li><a href="#customizing-sensitivity-analysis-parameters-optional" id="toc-customizing-sensitivity-analysis-parameters-optional" class="nav-link" data-scroll-target="#customizing-sensitivity-analysis-parameters-optional"><span class="header-section-number">12</span> Customizing Sensitivity Analysis Parameters (Optional)</a>
  <ul class="collapse">
  <li><a href="#optional-use-this-section-only-if-you-want-to-override-the-default-sensitivity-analysis-parameters.-skip-if-defaults-are-sufficient." id="toc-optional-use-this-section-only-if-you-want-to-override-the-default-sensitivity-analysis-parameters.-skip-if-defaults-are-sufficient." class="nav-link" data-scroll-target="#optional-use-this-section-only-if-you-want-to-override-the-default-sensitivity-analysis-parameters.-skip-if-defaults-are-sufficient."><span class="header-section-number">12.1</span> (Optional) Use this section only if you want to override the default sensitivity analysis parameters. Skip if defaults are sufficient.</a></li>
  </ul></li>
  <li><a href="#extract-model-results-and-prepare-for-analysis" id="toc-extract-model-results-and-prepare-for-analysis" class="nav-link" data-scroll-target="#extract-model-results-and-prepare-for-analysis"><span class="header-section-number">13</span> Extract Model Results and Prepare for Analysis</a></li>
  <li><a href="#display-available-model-variables" id="toc-display-available-model-variables" class="nav-link" data-scroll-target="#display-available-model-variables"><span class="header-section-number">14</span> Display Available Model Variables</a></li>
  <li><a href="#visualize-model-results" id="toc-visualize-model-results" class="nav-link" data-scroll-target="#visualize-model-results"><span class="header-section-number">15</span> Visualize Model Results</a>
  <ul class="collapse">
  <li><a href="#plot-carbon-fluxes" id="toc-plot-carbon-fluxes" class="nav-link" data-scroll-target="#plot-carbon-fluxes"><span class="header-section-number">15.1</span> Plot Carbon Fluxes</a></li>
  <li><a href="#plot-carbon-pools" id="toc-plot-carbon-pools" class="nav-link" data-scroll-target="#plot-carbon-pools"><span class="header-section-number">15.2</span> Plot Carbon Pools</a></li>
  <li><a href="#plot-water-variables" id="toc-plot-water-variables" class="nav-link" data-scroll-target="#plot-water-variables"><span class="header-section-number">15.3</span> Plot Water Variables</a></li>
  <li><a href="#plot-lai-and-biomass" id="toc-plot-lai-and-biomass" class="nav-link" data-scroll-target="#plot-lai-and-biomass"><span class="header-section-number">15.4</span> Plot LAI and Biomass</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">16</span> Conclusion</a></li>
  <li><a href="#further-exploration" id="toc-further-exploration" class="nav-link" data-scroll-target="#further-exploration"><span class="header-section-number">17</span> Further Exploration</a></li>
  <li><a href="#clean-up-workflow-output-optional" id="toc-clean-up-workflow-output-optional" class="nav-link" data-scroll-target="#clean-up-workflow-output-optional"><span class="header-section-number">18</span> Clean Up Workflow Output (Optional)</a></li>
  <li><a href="#session-information" id="toc-session-information" class="nav-link" data-scroll-target="#session-information"><span class="header-section-number">19</span> Session Information</a>
  <ul class="collapse">
  <li><a href="#pecan-package-versions." id="toc-pecan-package-versions." class="nav-link" data-scroll-target="#pecan-package-versions."><span class="header-section-number">19.0.1</span> PEcAn package versions.</a></li>
  <li><a href="#r-session-information" id="toc-r-session-information" class="nav-link" data-scroll-target="#r-session-information"><span class="header-section-number">19.0.2</span> R session information:</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="../../../uncertainty.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Uncertainty Analysis Using PEcAn</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Aritra Dey </p>
             <p>David LeBauer </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>In Demo 2 we will be looking at how PEcAn can use information about parameter uncertainty to perform three automated analyses:</p>
<ul>
<li><strong>Ensemble Analysis</strong>: Repeat numerous model runs, each sampling from the parameter uncertainty, to generate a probability distribution of model projections. Allows us to put a confidence interval on the model.</li>
<li><strong>Sensitivity Analysis</strong>: Repeats numerous model runs to assess how changes in model parameters will affect model outputs. Allows us to identify which parameters the model is most sensitive to.</li>
<li><strong>Uncertainty Analysis</strong>: Combines information about model sensitivity with information about parameter uncertainty to determine the contribution of each model parameter to the uncertainty in model outputs. Allow us to identify which parameters are driving model uncertainty.</li>
</ul>
<p>This demo shows how to run an uncertainty analysis workflow in PEcAn using an R-based Quarto notebook. It covers loading settings, configuring models, running simulations, and performing ensemble and sensitivity analyses to assess uncertainty and parameter importance. This programmatic approach complements the web-based PEcAn interface.</p>
<p><strong>Context &amp; modeling scenario:</strong></p>
<p>We simulate plant and ecosystem carbon balance (Net Primary Productivity and Net Ecosystem Exchange) at the AmeriFlux Niwot Ridge Forest site (<a href="https://ameriflux.lbl.gov/sites/siteinfo/US-NR1">US‑NR1</a>) during the year 2004. We use SIPNET parameterized as a temperate conifer PFT and driven by AmeriFlux meteorology following the analysis in <a href="https://doi.org/10.1016/j.agrformet.2008.04.013">Moore et al.&nbsp;(2007)</a>. This notebook also provides a compact template that can be extended to more years, locations, and PFTs.</p>
<p><strong>What this notebook does:</strong></p>
<ol type="1">
<li>Configure a PEcAn workflow by loading and validating a <code>pecan.xml</code> settings file.</li>
<li>Run a set of ecosystem model simulations by writing model configuration files and then running SIPNET.</li>
<li>Quantify uncertainty using ensemble analysis, sensitivity analyses, and variance decomposition.</li>
<li>Visualize results to identify important parameters and how they influence model variance.</li>
<li>Change configuration settings and re-run the workflow.</li>
</ol>
<section id="prerequisites" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="prerequisites"><span class="header-section-number">1.1</span> Prerequisites</h2>
<p>To run this notebook, you will need to install PEcAn and its dependencies, as well as download the SIPNET model binary.</p>
<section id="pecan-packages-and-dependencies." class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="pecan-packages-and-dependencies."><span class="header-section-number">1.1.1</span> PEcAn packages and dependencies.</h3>
<pre><code># Enable repository from pecanproject
options(repos = c(
  pecanproject = 'https://pecanproject.r-universe.dev',
  CRAN = 'https://cloud.r-project.org'))
install.packages(c('PEcAn.all', 'PEcAn.SIPNET'))</code></pre>
<p>A valid <code>pecan.xml</code> configuration file. Start with the example at <code>pecan/documentation/tutorials/Demo_02_Uncertainty_Analysis/pecan.xml</code>.</p>
</section>
<section id="sipnet-v1.3.0" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="sipnet-v1.3.0"><span class="header-section-number">1.1.2</span> SIPNET v1.3.0</h3>
<p>If you haven’t already installed the SIPNET model, you can do so by running the following code. This will download the SIPNET binary to <code>demo_outdir/sipnet</code> and make it executable.</p>
<blockquote class="blockquote">
<p>Note: The <code>demo_outdir</code> directory will be created inside of your PEcAn installation, at <code>documentation/tutorials/Demo_02_Uncertainty_Analysis/demo_outdir/</code>. This directory will contain the SIPNET binary as well as the output generated by PEcAn in this demo.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and install SIPNET v1.3.0</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"documentation/tutorials/Demo_1_Basic_Run/download_sipnet.R"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>Note: You can find the most recent version of the SIPNET binary at: <a href="https://github.com/PecanProject/sipnet/releases">SIPNET GitHub Releases</a>, but this notebook is designed to work with SIPNET v1.3.0.</p>
</blockquote>
</section>
</section>
</section>
<section id="load-pecan-packages" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Load PEcAn Packages</h1>
<p>First, we need to load the PEcAn R packages. These packages provide all the functions we’ll use to run the workflow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the PEcAn.all package, which includes all necessary PEcAn functionality</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"PEcAn.all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.DB</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.settings</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.MA</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.logger</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.utils</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.uncertainty</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.data.atmosphere</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.data.land</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.data.remote</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.assim.batch</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.emulator</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.priors</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.benchmark</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.remote</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.workflow</code></pre>
</div>
</div>
</section>
<section id="load-pecan-settings-file" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Load PEcAn Settings File</h1>
<p>Use the XML settings file (<code>pecan.xml</code>) exactly as in the Demo 1 Basic Run tutorial. See the “Load PEcAn Settings File” section of Demo 1 for a more detailed walkthrough of fields and schema. In this tutorial we focus on settings relevant to this notebook and explain the additional options associated with uncertainty analysis.</p>
<section id="settings" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="settings"><span class="header-section-number">3.1</span> Settings</h2>
<p>Example settings for this demo live at <code>pecan/documentation/tutorials/Demo_02_Uncertainty_Analysis/pecan.xml</code> and you can read more about the settings in the <a href="https://pecanproject.github.io/pecan-documentation/develop/pecanXML.html#pecanXML">PEcAn Documentation</a>, and sections focused on <a href="https://pecanproject.github.io/pecan-documentation/develop/xml-advanced.html#xml-ensemble">ensemble</a> and <a href="https://pecanproject.github.io/pecan-documentation/develop/xml-advanced.html#xml-sensitivity-analysis">sensitivity analysis</a> settings in particular.</p>
<p>Open that settings file and look at the ensemble and sensitivity analysis sections. You can modify these settings to change the number of ensemble members, the variable to analyze, and the sampling method. Some of the key settings in this demo include:</p>
<p><strong>Ensemble size</strong></p>
<p>The number of runs in the ensemble is set to <strong>50</strong> in this demo, but a larger ensemble size (100-5000) is often used in practice to better estimate the posterior distribution of the output.</p>
<p><strong>Output variable</strong></p>
<p>The output variable for the ensemble analysis is set to <strong>NPP</strong> (Net Primary Productivity). You can change this to other variables like NEE (Net Ecosystem Exchange), LAI (Leaf Area Index), ET (Evapotranspiration), etc. You can also specify multiple variables by providing a vector of variable names (e.g., <code>c("NPP", "NEE", "LAI")</code>) to analyze uncertainty across several ecosystem processes simultaneously.</p>
<p><strong>Sampling method</strong></p>
<p>The sampling method for generating parameter sets is set to <strong>halton</strong> in this demo. This tells PEcAn to sample using the <a href="https://en.wikipedia.org/wiki/Halton_sequence">Halton sequence</a>, which is a quasi-random sampling method that more efficiently explores parameter space than random sampling. Other options include Latin Hypercube (lhc), which is another quasi-random sequence, as well as uniform that draws random samples. A random sampler requires a larger ensemble size to adequately explore parameter space.</p>
<p><strong>Sensitivity analysis quantiles</strong></p>
<p>PEcAn’s sensitivity analysis includes a handy shortcut that converts a specified standard deviation into its normal quantile equivalent. In the example pecan.xml, these are set to <strong>-1, 1</strong> (the median value, 0, occurs by default) which are converted internally to the 15.9th and 84.1th quantiles of the parameter distribution. You can add more quantiles to explore a wider range of parameter values: {-3, -2, -1, 1, 2, 3} is often used in practice.</p>
<p>By working in quantiles relative to each parameter’s distribution, the sensitivity and variance decomposition reflect sensitivity across the range of parameter values. Many sensitivity analyses tools use a fixed perturbation size such as the mean +/- 10%. PEcAn’s SA does not take this approach because it does not capture the uncertainty across the parameter distribution and can not be used for variance decomposition.</p>
</section>
<section id="load-the-settings-file" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="load-the-settings-file"><span class="header-section-number">3.2</span> Load the settings file</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>settings_path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"documentation/tutorials/Demo_02_Uncertainty_Analysis/pecan.xml"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>settings <span class="ot">&lt;-</span> PEcAn.settings<span class="sc">::</span><span class="fu">read.settings</span>(settings_path)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>settings <span class="ot">&lt;-</span> PEcAn.settings<span class="sc">::</span><span class="fu">prepare.settings</span>(settings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>See Demo 1 Section 6 for details on what these functions do. Briefly, they read the XML file, convert it into an R list object that PEcAn can use, check that settings are valid, fill in defaults, and create the output directory.</p>
</section>
</section>
<section id="sec-write-configs" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Write Model Configuration Files</h1>
<p>This step generates the model-specific configuration files that will be used to run the ecosystem model. The process involves:</p>
<ol start="2" type="1">
<li>Generating SIPNET configuration files using the <code>runModule.run.write.configs()</code> function.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>settings <span class="ot">&lt;-</span> PEcAn.workflow<span class="sc">::</span><span class="fu">runModule.run.write.configs</span>(settings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in postgresqlNewConnection(drv, ...) : 
  RPosgreSQL error: could not connect root@/var/run/postgresql:5432 on dbname "root": connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: No such file or directory
    Is the server running locally and accepting connections on that socket?</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: PEcAn.SIPNET</code></pre>
</div>
</div>
</section>
<section id="run-model-simulations" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Run Model Simulations</h1>
<p>This section executes the SIPNET simulations and retrieves the results.</p>
<p>It uses the function <code>runModule_start_model_runs(settings)</code> to initiate the model runs using the configuration files generated in the previous step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>PEcAn.workflow<span class="sc">::</span><span class="fu">runModule_start_model_runs</span>(settings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |==                                                                    |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |==========                                                            |  15%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |================                                                      |  22%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |====================                                                  |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |========================                                              |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |===========================                                           |  38%
  |                                                                            
  |============================                                          |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |===============================                                       |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |==================================                                    |  48%
  |                                                                            
  |===================================                                   |  49%
  |                                                                            
  |===================================                                   |  51%
  |                                                                            
  |====================================                                  |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |======================================                                |  54%
  |                                                                            
  |=======================================                               |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |==========================================                            |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |==============================================                        |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |==================================================                    |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |============================================================          |  85%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |================================================================      |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |====================================================================  |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
</div>
<p>The PEcAn workflow will take a longer time to complete than in Demo 1 because we have just asked for over a hundred model runs. Once the runs are complete we will continue.</p>
</section>
<section id="fetch-model-outputs" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Fetch Model Outputs</h1>
<p>Next we convert all of the model output from the previous run to a standard format that PEcAn can use for analysis. This is done using the <code>runModule.get.results()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">runModule.get.results</span>(settings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-run-uncertainty" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Ensemble and Sensitivity Analysis</h1>
<p>Next, we use the outputs from the previous step to perform ensemble and sensitivity analyses.</p>
<p><strong>Ensemble Analysis</strong>: Quantifies uncertainty in model predictions by running multiple simulations with parameters sampled from their uncertainty distributions. This generates probability distributions of model outputs and confidence intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">runModule.run.ensemble.analysis</span>(settings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "----- Variable: NPP"
[1] "----- Running ensemble analysis for site:  Niwot Ridge Forest/LTER NWT1 (US-NR1)"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "----- Done!"
[1] " "
[1] "-----------------------------------------------"
[1] " "
[1] " "</code></pre>
</div>
</div>
<p><strong>Sensitivity Analysis</strong>: Systematically varies individual parameters to assess their influence on model outputs. This identifies which parameters most strongly affect model predictions and helps prioritize parameter refinement efforts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">runModule.run.sensitivity.analysis</span>(settings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$coef.vars
         growth_resp_factor          leaf_turnover_rate 
                 0.52314023                  0.88169612 
      root_respiration_rate          root_turnover_rate 
                 0.57750504                  0.57760373 
                       Amax    leaf_respiration_rate_m2 
                 0.57764863                  0.55600452 
                        SLA                       leafC 
                 0.80223473                  0.02607590 
                Vm_low_temp                    AmaxFrac 
                 0.01097613                  0.11546966 
                    psnTOpt       stem_respiration_rate 
                 0.03417927                  0.57838935 
     extinction_coefficient         half_saturation_PAR 
                 0.13855053                  0.42885852 
                  dVPDSlope                     dVpdExp 
                 0.53356551                  0.28896893 
        veg_respiration_Q10   fine_root_respiration_Q10 
                 0.17324390                  0.32501552 
coarse_root_respiration_Q10 
                 0.32534666 

$elasticities
         growth_resp_factor          leaf_turnover_rate 
                 0.00000000                  0.02320464 
      root_respiration_rate          root_turnover_rate 
                -0.02508999                  0.05192989 
                       Amax    leaf_respiration_rate_m2 
                 2.83476962                 -2.06513816 
                        SLA                       leafC 
                 0.81446798                  0.15306831 
                Vm_low_temp                    AmaxFrac 
                 1.01795920                  2.48502840 
                    psnTOpt       stem_respiration_rate 
                 1.01055079                 -1.43854509 
     extinction_coefficient         half_saturation_PAR 
                -0.57229325                 -1.28681308 
                  dVPDSlope                     dVpdExp 
                -0.18295933                  0.09271587 
        veg_respiration_Q10   fine_root_respiration_Q10 
                 6.50084187                  0.08360650 
coarse_root_respiration_Q10 
                -0.23722866 

$sensitivities
         growth_resp_factor          leaf_turnover_rate 
               0.000000e+00                9.970835e-11 
      root_respiration_rate          root_turnover_rate 
              -2.359663e-12                4.884707e-11 
                       Amax    leaf_respiration_rate_m2 
               6.666635e-10               -1.944744e-09 
                        SLA                       leafC 
               2.732070e-10                1.422201e-11 
                Vm_low_temp                    AmaxFrac 
              -9.748919e-10                1.557956e-08 
                    psnTOpt       stem_respiration_rate 
               2.423273e-10               -1.355162e-10 
     extinction_coefficient         half_saturation_PAR 
              -5.381744e-09               -3.907003e-10 
                  dVPDSlope                     dVpdExp 
              -6.624579e-09                2.181281e-10 
        veg_respiration_Q10   fine_root_respiration_Q10 
               1.528495e-08                1.229585e-10 
coarse_root_respiration_Q10 
              -3.491744e-10 

$variances
         growth_resp_factor          leaf_turnover_rate 
               5.983871e-50                1.785332e-20 
      root_respiration_rate          root_turnover_rate 
               4.672753e-21                2.193432e-20 
                       Amax    leaf_respiration_rate_m2 
               6.122857e-17                2.785313e-17 
                        SLA                       leafC 
               1.096593e-17                3.746338e-22 
                Vm_low_temp                    AmaxFrac 
               8.542850e-18                1.822057e-18 
                    psnTOpt       stem_respiration_rate 
               5.995813e-18                1.530077e-17 
     extinction_coefficient         half_saturation_PAR 
               1.389601e-19                6.768366e-18 
                  dVPDSlope                     dVpdExp 
               2.123853e-19                1.622220e-20 
        veg_respiration_Q10   fine_root_respiration_Q10 
               2.851950e-17                1.785504e-20 
coarse_root_respiration_Q10 
               1.316744e-19 

$partial.variances
         growth_resp_factor          leaf_turnover_rate 
               3.571204e-34                1.065495e-04 
      root_respiration_rate          root_turnover_rate 
               2.788722e-05                1.309051e-04 
                       Amax    leaf_respiration_rate_m2 
               3.654152e-01                1.662288e-01 
                        SLA                       leafC 
               6.544522e-02                2.235833e-06 
                Vm_low_temp                    AmaxFrac 
               5.098415e-02                1.087413e-02 
                    psnTOpt       stem_respiration_rate 
               3.578331e-02                9.131574e-02 
     extinction_coefficient         half_saturation_PAR 
               8.293210e-04                4.039395e-02 
                  dVPDSlope                     dVpdExp 
               1.267526e-03                9.681491e-05 
        veg_respiration_Q10   fine_root_respiration_Q10 
               1.702058e-01                1.065597e-04 
coarse_root_respiration_Q10 
               7.858395e-04 

       growth_resp_factor leaf_turnover_rate root_respiration_rate
15.866       4.701256e-09       4.449915e-09          4.793975e-09
50           4.701256e-09       4.701256e-09          4.701256e-09
84.134       4.701256e-09       4.739615e-09          4.632887e-09
       root_turnover_rate          Amax leaf_respiration_rate_m2          SLA
15.866       4.437930e-09 -7.392576e-09             9.995320e-09 7.454526e-10
50           4.701256e-09  4.701256e-09             4.701256e-09 4.701256e-09
84.134       4.771365e-09  1.080759e-08            -8.726093e-10 4.574289e-10
              leafC  Vm_low_temp     AmaxFrac       psnTOpt
15.866 4.689967e-09 6.977459e-09 3.003852e-09 -5.232746e-09
50     4.701256e-09 4.701256e-09 4.701256e-09  4.701256e-09
84.134 4.727503e-09 1.776842e-09 6.194027e-09  7.597368e-09
       stem_respiration_rate extinction_coefficient half_saturation_PAR
15.866          9.335914e-09           5.145403e-09        8.187772e-09
50              4.701256e-09           4.701256e-09        4.701256e-09
84.134          8.203046e-11           4.264066e-09        2.050097e-09
          dVPDSlope      dVpdExp veg_respiration_Q10 fine_root_respiration_Q10
15.866 5.155744e-09 4.511517e-09       -3.046701e-09              4.466264e-09
50     4.701256e-09 4.701256e-09        4.701256e-09              4.701256e-09
84.134 4.070785e-09 4.809312e-09        9.472557e-09              4.768234e-09
       coarse_root_respiration_Q10
15.866                5.142842e-09
50                    4.701256e-09
84.134                4.284874e-09</code></pre>
</div>
</div>
</section>
<section id="sec-outputs" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> PEcAn Outputs</h1>
<section id="output-directory-structure" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="output-directory-structure"><span class="header-section-number">8.1</span> Output Directory Structure</h2>
<p>These are the key folders and files that will be created under the directory defined by <code>settings$outdir</code> (e.g., <code>demo_outdir</code> in the example). The file contents are described in the next section.</p>
<p>We discussed the output directory in Demo 1 (Basic Run), but now we have three new folders that contain outputs from the sensitivity, ensemble, and variance decomposition analyses. Here we focus on the additional outputs generated by the ensemble and sensitivity analyses.</p>
<pre><code>demo_outdir/
├── run/                                    # Configuration &amp; execution metadata
│   ├── runs.txt                           # List of run IDs (SA and ensemble runs)
│   ├── ENS-*-*/                          # Ensemble run directories (e.g., ENS-00001--1/)
│   └── SA-*-*/                           # Sensitivity analysis run directories
├── out/                                   # Raw model outputs by run ID
│   └── &lt;runid&gt;/                          # E.g., daily or sub-daily SIPNET output files
├── ensemble.analysis.*.pdf                # Ensemble analysis plots
├── ensemble.output.*.Rdata               # Raw ensemble outputs
├── ensemble.samples.*.Rdata              # Parameter samples used for ensemble
├── ensemble.ts.*.Rdata                   # Time series data from ensemble
├── samples.Rdata                         # Parameter samples for both SA and ensemble
├── sensitivity.output.*.Rdata            # SA model outputs
├── sensitivity.results.*.Rdata           # Processed SA results
├── sensitivity.samples.*.Rdata           # SA parameter samples
├── variance.decomposition.*.pdf          # Variance decomposition analysis
├── pft/                                  # Parameter (prior/posterior) files per PFT
│   └── temperate.coniferous/
└── sipnet                                # SIPNET binary (downloaded earlier)</code></pre>
<section id="model-outputs-and-logs" class="level3" data-number="8.1.1">
<h3 data-number="8.1.1" class="anchored" data-anchor-id="model-outputs-and-logs"><span class="header-section-number">8.1.1</span> Model outputs and logs</h3>
<ul>
<li>Standardized netCDF files (<code>[year].nc</code>) for analysis and visualization</li>
<li>Raw model output (for SIPNET, e.g., <code>sipnet.out</code> per run)</li>
<li><code>logfile.txt</code> with model and workflow messages</li>
<li>Note: <code>pft/</code> contains parameter files used in estimation; see the parameter-estimation tutorial (Demo 3) for details</li>
</ul>
</section>
</section>
</section>
<section id="understanding-pecan-uncertainty-analysis-outputs" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Understanding PEcAn Uncertainty Analysis Outputs</h1>
<p>After running ensemble and sensitivity analyses, PEcAn generates several important outputs that help you understand model uncertainty and parameter sensitivity.</p>
<p>The <code>samples.Rdata</code> file contains the parameter values used in the sensitivity and ensemble runs. It stores two objects, <code>sa.samples</code> and <code>ensemble.samples</code>, which are the parameter values for the sensitivity analysis and ensemble runs, respectively.</p>
<section id="ensemble-analysis-outputs" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="ensemble-analysis-outputs"><span class="header-section-number">9.1</span> Ensemble Analysis Outputs</h2>
<p>The ensemble analysis produces:</p>
<ul>
<li><strong><code>ensemble.Rdata</code></strong>: Contains <code>ensemble.output</code> object with model predictions for all ensemble members</li>
<li><strong><code>ensemble.analysis.[RunID].[Variable].[StartYear].[EndYear].pdf</code></strong>: Histogram and boxplot of ensemble predictions</li>
<li><strong><code>ensemble.ts.[RunID].[Variable].[StartYear].[EndYear].pdf</code></strong>: Time-series plot showing ensemble mean, median, and 95% confidence intervals</li>
</ul>
</section>
<section id="sensitivity-analysis-outputs" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="sensitivity-analysis-outputs"><span class="header-section-number">9.2</span> Sensitivity Analysis Outputs</h2>
<p>The sensitivity analysis generates:</p>
<ul>
<li><strong><code>sensitivity.analysis.[RunID].[Variable].[StartYear].[EndYear].pdf</code></strong>: Raw data points from univariate analyses with spline fits.</li>
<li><strong><code>sensitivity.output.[RunID].[Variable].[StartYear].[EndYear].Rdata</code></strong>: Model outputs corresponding to parameter variations.</li>
<li><code>sensitivity.analysis.[RunID].[Variable].[StartYear].[EndYear].pdf</code> shows the raw data points from univariate one-at-a-time analyses and spline fits through the points. <em>Open this file</em> to determine which parameters are most and least sensitive.</li>
</ul>
</section>
<section id="variance-decomposition-outputs" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="variance-decomposition-outputs"><span class="header-section-number">9.3</span> Variance Decomposition Outputs</h2>
<p>The variance decomposition produces:</p>
<ul>
<li><strong><code>variance.decomposition.[RunID].[Variable].[StartYear].[EndYear].pdf</code></strong>: Three-column analysis showing:
<ul>
<li>Coefficient of variation (normalized posterior variance)</li>
<li>Elasticity (normalized sensitivity)</li>
<li>Partial standard deviation of each parameter</li>
</ul></li>
</ul>
</section>
<section id="interpreting-the-results" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="interpreting-the-results"><span class="header-section-number">9.4</span> Interpreting the Results</h2>
<p><strong>Variance Decomposition Analysis:</strong></p>
<ul>
<li>Parameters are sorted by their contribution to model output uncertainty (the right column).</li>
<li>Identify parameters that are:
<ul>
<li>Highly sensitive but low uncertainty.</li>
<li>Highly uncertain but low sensitivity.</li>
<li>Both sensitive and uncertain.</li>
</ul></li>
<li>Identify parameters that are both sensitive and uncertain for future constraint with data or expert knowledge.</li>
<li>Potential gotchas:
<ul>
<li>Flat sensitivity curves: check that parameter values were correctly generated and read by the model.</li>
<li>Parameters with high uncertainty: consider revising priors.</li>
<li>Multi-modal or otherwise unexpected parameter distributions: check that parameter was specified correctly.</li>
</ul></li>
</ul>
<p><strong>Choose the parameter that you think provides the most efficient means of reducing model uncertainty and propose how you might best reduce uncertainty in this process</strong>. In making this choice remember that not all processes in models can be directly observed, and that the cost-per-sample for different measurements can vary tremendously (and thus the parameter you measure next is not always the one contributing the most to model variability). Also consider the role of parameter uncertainty versus model sensitivity in justifying your choice of what parameters to constrain.</p>
</section>
</section>
<section id="sec-visualize" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Visualize Uncertainty Analysis Results</h1>
<p>This section loads the results from the uncertainty analyses and generates plots directly in the notebook. This provides an immediate view of the ensemble time series, sensitivity plots, and variance decomposition.</p>
<section id="ensemble-analysis-visualization" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="ensemble-analysis-visualization"><span class="header-section-number">10.1</span> Ensemble Analysis Visualization</h2>
<p>Here we visualize the results of the ensemble analysis. It shows the overall distribution of the model output and how the output and its uncertainty change over time.</p>
<p>This section reproduces the plots saved in the <code>ensemble.analysis/</code> folder in order to show the user how to access and visualize the results programmatically so that they can further investigate output and customize plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Define Helper Variables ---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract key variables from the settings object to simplify file path construction</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># and plotting. This makes the code cleaner and easier to read.</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>variable <span class="ot">&lt;-</span> settings<span class="sc">$</span>ensemble<span class="sc">$</span>variable</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>pft <span class="ot">&lt;-</span> settings<span class="sc">$</span>pfts[[<span class="dv">1</span>]]</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>start.year <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">year</span>(settings<span class="sc">$</span>run<span class="sc">$</span>start.date)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>end.year <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">year</span>(settings<span class="sc">$</span>run<span class="sc">$</span>end.date)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>ensemble.id <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(settings<span class="sc">$</span>ensemble<span class="sc">$</span>id)) settings<span class="sc">$</span>ensemble<span class="sc">$</span>id <span class="cf">else</span> <span class="st">"NOENSEMBLEID"</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Load and Plot Ensemble Output Distribution ---</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co"># This section visualizes the distribution of the ensemble model runs.</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co"># It generates a histogram and a boxplot to show the central tendency, spread,</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># and shape of the output variable's distribution.</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct the path to the ensemble output file</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>ens_file <span class="ot">&lt;-</span> PEcAn.uncertainty<span class="sc">::</span><span class="fu">ensemble.filename</span>(</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  settings,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">prefix =</span> <span class="st">"ensemble.output"</span>,</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">ensemble.id =</span> ensemble.id,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> variable,</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">start.year =</span> start.year,</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">end.year =</span> end.year</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the file exists, then load and plot the data</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(ens_file)) {</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>  ens_env <span class="ot">&lt;-</span> <span class="fu">new.env</span>()</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(ens_file, <span class="at">envir =</span> ens_env)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>  ens_data <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">unlist</span>(ens_env<span class="sc">$</span>ensemble.output))</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define units for plot labels</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>  units <span class="ot">&lt;-</span> <span class="fu">paste0</span>(variable, <span class="st">" ("</span>, PEcAn.utils<span class="sc">::</span><span class="fu">mstmipvar</span>(variable, <span class="at">silent =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>units, <span class="st">")"</span>)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create side-by-side histogram and boxplot</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="fl">4.8</span>, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hist</span>(ens_data, <span class="at">xlab =</span> units, <span class="at">main =</span> <span class="st">"Ensemble Distribution"</span>, <span class="at">cex.lab =</span> <span class="fl">1.4</span>, <span class="at">col =</span> <span class="st">"grey85"</span>)</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">box</span>(<span class="at">lwd =</span> <span class="fl">2.2</span>)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boxplot</span>(ens_data, <span class="at">ylab =</span> units, <span class="at">main =</span> <span class="st">"Ensemble Boxplot"</span>, <span class="at">col =</span> <span class="st">"grey85"</span>, <span class="at">cex.lab =</span> <span class="fl">1.5</span>)</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">box</span>(<span class="at">lwd =</span> <span class="fl">2.2</span>)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>  PEcAn.logger<span class="sc">::</span><span class="fu">logger.warn</span>(<span class="st">"Could not find ensemble output file:"</span>, ens_file)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Plot Ensemble Time Series ---</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a><span class="co"># This section visualizes the ensemble results over time, showing the mean,</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a><span class="co"># median, and 95% confidence interval of the model output.</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>ens_ts_data <span class="ot">&lt;-</span> PEcAn.uncertainty<span class="sc">::</span><span class="fu">read.ensemble.ts</span>(settings, <span class="at">variable =</span> variable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "----- Variable: NPP"
[1] "----- Reading ensemble output ------"
[1] "ENS-00001--1"
[1] "ENS-00002--1"
[1] "ENS-00003--1"
[1] "ENS-00004--1"
[1] "ENS-00005--1"
[1] "ENS-00006--1"
[1] "ENS-00007--1"
[1] "ENS-00008--1"
[1] "ENS-00009--1"
[1] "ENS-00010--1"
[1] "ENS-00011--1"
[1] "ENS-00012--1"
[1] "ENS-00013--1"
[1] "ENS-00014--1"
[1] "ENS-00015--1"
[1] "ENS-00016--1"
[1] "ENS-00017--1"
[1] "ENS-00018--1"
[1] "ENS-00019--1"
[1] "ENS-00020--1"
[1] "ENS-00021--1"
[1] "ENS-00022--1"
[1] "ENS-00023--1"
[1] "ENS-00024--1"
[1] "ENS-00025--1"
[1] "ENS-00026--1"
[1] "ENS-00027--1"
[1] "ENS-00028--1"
[1] "ENS-00029--1"
[1] "ENS-00030--1"
[1] "ENS-00031--1"
[1] "ENS-00032--1"
[1] "ENS-00033--1"
[1] "ENS-00034--1"
[1] "ENS-00035--1"
[1] "ENS-00036--1"
[1] "ENS-00037--1"
[1] "ENS-00038--1"
[1] "ENS-00039--1"
[1] "ENS-00040--1"
[1] "ENS-00041--1"
[1] "ENS-00042--1"
[1] "ENS-00043--1"
[1] "ENS-00044--1"
[1] "ENS-00045--1"
[1] "ENS-00046--1"
[1] "ENS-00047--1"
[1] "ENS-00048--1"
[1] "ENS-00049--1"
[1] "ENS-00050--1"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(ens_ts_data)) {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  PEcAn.uncertainty<span class="sc">::</span><span class="fu">ensemble.ts</span>(ens_ts_data)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "------ Generating ensemble time-series plot ------"</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="uncertainty_files/figure-html/visualize-ensemble-results-1.png" class="img-fluid figure-img" width="3000"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sensitivity-and-variance-decomposition-visualization" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="sensitivity-and-variance-decomposition-visualization"><span class="header-section-number">10.2</span> Sensitivity and Variance Decomposition Visualization</h2>
<p>This block visualizes the results of the sensitivity analysis. The plots show how sensitive the model output is to changes in each parameter and which parameters contribute most to the overall uncertainty.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Load Sensitivity Analysis Results ---</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This section loads the saved sensitivity analysis data, which contains the</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># outputs needed to generate the sensitivity and variance decomposition plots.</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct the path to the sensitivity analysis results file</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>sens_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  settings<span class="sc">$</span>outdir,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"sensitivity.results"</span>, <span class="st">"."</span>, ensemble.id, <span class="st">"."</span>, variable, <span class="st">"."</span>, start.year, <span class="st">"."</span>, end.year, <span class="st">".Rdata"</span>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the file exists, then load the data and generate plots</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(sens_file)) {</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  sens_env <span class="ot">&lt;-</span> <span class="fu">new.env</span>()</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(sens_file, <span class="at">envir =</span> sens_env)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  sensitivity.results <span class="ot">&lt;-</span> sens_env<span class="sc">$</span>sensitivity.results</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 2. Generate Sensitivity Plots ---</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># These plots show how the model output changes as each parameter is varied</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># one at a time, helping to identify which parameters have the strongest influence.</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  sa_plots <span class="ot">&lt;-</span> PEcAn.uncertainty<span class="sc">::</span><span class="fu">plot_sensitivities</span>(</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    sensitivity.results[[pft<span class="sc">$</span>name]]<span class="sc">$</span>sensitivity.output</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">do.call</span>(gridExtra<span class="sc">::</span>grid.arrange, <span class="fu">c</span>(sa_plots, <span class="at">ncol =</span> <span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">length</span>(sa_plots))))))</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 3. Generate Variance Decomposition Plots ---</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># These plots break down the total output variance into contributions from</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># each parameter, highlighting the most important sources of uncertainty.</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>  vd_plots <span class="ot">&lt;-</span> PEcAn.uncertainty<span class="sc">::</span><span class="fu">plot_variance_decomposition</span>(</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>    sensitivity.results[[pft<span class="sc">$</span>name]]<span class="sc">$</span>variance.decomposition.output</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">do.call</span>(gridExtra<span class="sc">::</span>grid.arrange, <span class="fu">c</span>(vd_plots, <span class="at">ncol =</span> <span class="dv">4</span>)))</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>  PEcAn.logger<span class="sc">::</span><span class="fu">logger.warn</span>(<span class="st">"Could not find sensitivity results file:"</span>, sens_file)</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="customizing-ensemble-analysis-parameters-optional" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Customizing Ensemble Analysis Parameters (Optional)</h1>
<section id="optional-use-this-section-only-if-you-want-to-override-the-default-ensemble-analysis-parameters.-skip-if-defaults-are-sufficient." class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="optional-use-this-section-only-if-you-want-to-override-the-default-ensemble-analysis-parameters.-skip-if-defaults-are-sufficient."><span class="header-section-number">11.1</span> (Optional) Use this section only if you want to override the default ensemble analysis parameters. Skip if defaults are sufficient.</h2>
<blockquote class="blockquote">
<p><strong>Important:</strong> If you modify the ensemble analysis parameters in this section, re-run Section <a href="#sec-run-uncertainty" class="quarto-xref">Section&nbsp;7</a> and then Section <a href="#sec-visualize" class="quarto-xref">Section&nbsp;10</a> to regenerate outputs and plots.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the number of ensemble members (model runs)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>settings<span class="sc">$</span>ensemble<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the variable(s) to be analyzed in the ensemble</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Single variable:</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>settings<span class="sc">$</span>ensemble<span class="sc">$</span>variable <span class="ot">&lt;-</span> <span class="st">"NEE"</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiple variables (uncomment to use):</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># settings$ensemble$variable &lt;- c("NEE", "NPP", "LAI")</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose the method for sampling the parameter space (options: "uniform", "lhc", "halton", "sobol", "torus")</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>settings<span class="sc">$</span>ensemble<span class="sc">$</span>samplingspace<span class="sc">$</span>parameters<span class="sc">$</span>method <span class="ot">&lt;-</span> <span class="st">"halton"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="customizing-sensitivity-analysis-parameters-optional" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Customizing Sensitivity Analysis Parameters (Optional)</h1>
<section id="optional-use-this-section-only-if-you-want-to-override-the-default-sensitivity-analysis-parameters.-skip-if-defaults-are-sufficient." class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="optional-use-this-section-only-if-you-want-to-override-the-default-sensitivity-analysis-parameters.-skip-if-defaults-are-sufficient."><span class="header-section-number">12.1</span> (Optional) Use this section only if you want to override the default sensitivity analysis parameters. Skip if defaults are sufficient.</h2>
<blockquote class="blockquote">
<p><strong>Important:</strong> If you modify the sensitivity analysis parameters in this section, re-run Section <a href="#sec-run-uncertainty" class="quarto-xref">Section&nbsp;7</a> and then Section <a href="#sec-visualize" class="quarto-xref">Section&nbsp;10</a> to regenerate outputs and plots.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the quantiles (in standard deviations) for parameter distribution in sensitivity analysis</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>settings<span class="sc">$</span>sensitivity.analysis<span class="sc">$</span>quantiles<span class="sc">$</span>sigma <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the variable to be analyzed in sensitivity analysis</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>settings<span class="sc">$</span>sensitivity.analysis<span class="sc">$</span>variable <span class="ot">&lt;-</span> <span class="st">"NEE"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="extract-model-results-and-prepare-for-analysis" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> Extract Model Results and Prepare for Analysis</h1>
<p>After the model simulation completes, we need to extract the results and prepare them for analysis. This involves:</p>
<ol type="1">
<li>Reading the run ID</li>
<li>Setting up output paths</li>
<li>Defining time period</li>
<li>Loading model output</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>runid <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">read.table</span>(<span class="fu">paste</span>(settings<span class="sc">$</span>outdir, <span class="st">"/run/"</span>, <span class="st">"runs.txt"</span>, <span class="at">sep =</span> <span class="st">""</span>))[<span class="dv">1</span>, <span class="dv">1</span>]) <span class="co"># Note: if you are using an xml from a run with multiple ensembles this line will provide only the first run id</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># You can change [1,1] to [10,1], [5,1], etc. to select different run IDs from runs.txt</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># For example: [10,1] selects the 10th run ID, [5,1] selects the 5th run ID</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>outdir <span class="ot">&lt;-</span> <span class="fu">paste</span>(settings<span class="sc">$</span>outdir, <span class="st">"/out/"</span>, runid, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>start.year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(lubridate<span class="sc">::</span><span class="fu">year</span>(settings<span class="sc">$</span>run<span class="sc">$</span>start.date))</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>end.year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(lubridate<span class="sc">::</span><span class="fu">year</span>(settings<span class="sc">$</span>run<span class="sc">$</span>end.date))</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>model_output <span class="ot">&lt;-</span> PEcAn.utils<span class="sc">::</span><span class="fu">read.output</span>(</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  runid,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  outdir,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  start.year,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  end.year,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="cn">NULL</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataframe =</span> <span class="cn">TRUE</span>,</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>available_vars <span class="ot">&lt;-</span> <span class="fu">names</span>(model_output)[<span class="sc">!</span><span class="fu">names</span>(model_output) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"posix"</span>, <span class="st">"time_bounds"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="display-available-model-variables" class="level1" data-number="14">
<h1 data-number="14"><span class="header-section-number">14</span> Display Available Model Variables</h1>
<p>This section shows all the variables that are available in the model output. These variables represent different ecosystem processes and states that the model has simulated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>vars_df <span class="ot">&lt;-</span> PEcAn.utils<span class="sc">::</span>standard_vars <span class="sc">|&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variable =</span> Variable.Name,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Description =</span> Long.name</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(Variable <span class="sc">%in%</span> available_vars) <span class="sc">|&gt;</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span><span class="al">TODO</span><span class="co">: add year to PEcAn.utils::standard vars</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">Variable =</span> <span class="st">"year"</span>,</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">Description =</span> <span class="st">"Year"</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>vars_df<span class="sc">$</span>Description[<span class="fu">is.na</span>(vars_df<span class="sc">$</span>Description)] <span class="ot">&lt;-</span> <span class="st">"(No description available)"</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(vars_df, <span class="at">caption =</span> <span class="st">"Model Output Variables and Descriptions"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Model Output Variables and Descriptions</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">GPP</td>
<td style="text-align: left;">Gross Primary Productivity</td>
</tr>
<tr class="even">
<td style="text-align: left;">NEE</td>
<td style="text-align: left;">Net Ecosystem Exchange</td>
</tr>
<tr class="odd">
<td style="text-align: left;">TotalResp</td>
<td style="text-align: left;">Total Respiration</td>
</tr>
<tr class="even">
<td style="text-align: left;">AutoResp</td>
<td style="text-align: left;">Autotrophic Respiration</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HeteroResp</td>
<td style="text-align: left;">Heterotrophic Respiration</td>
</tr>
<tr class="even">
<td style="text-align: left;">SoilResp</td>
<td style="text-align: left;">Soil Respiration</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NPP</td>
<td style="text-align: left;">Net Primary Productivity</td>
</tr>
<tr class="even">
<td style="text-align: left;">GWBI</td>
<td style="text-align: left;">Gross Woody Biomass Increment</td>
</tr>
<tr class="odd">
<td style="text-align: left;">TotLivBiom</td>
<td style="text-align: left;">Total living biomass</td>
</tr>
<tr class="even">
<td style="text-align: left;">AGB</td>
<td style="text-align: left;">Total aboveground biomass</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LAI</td>
<td style="text-align: left;">Leaf Area Index</td>
</tr>
<tr class="even">
<td style="text-align: left;">leaf_carbon_content</td>
<td style="text-align: left;">Leaf Carbon Content</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fine_root_carbon_content</td>
<td style="text-align: left;">Fine Root Carbon Content</td>
</tr>
<tr class="even">
<td style="text-align: left;">coarse_root_carbon_content</td>
<td style="text-align: left;">Coarse Root Carbon Content</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AbvGrndWood</td>
<td style="text-align: left;">Above ground woody biomass</td>
</tr>
<tr class="even">
<td style="text-align: left;">TotSoilCarb</td>
<td style="text-align: left;">Total Soil Carbon</td>
</tr>
<tr class="odd">
<td style="text-align: left;">litter_carbon_content</td>
<td style="text-align: left;">Litter Carbon Content</td>
</tr>
<tr class="even">
<td style="text-align: left;">Qle</td>
<td style="text-align: left;">Latent heat</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Transp</td>
<td style="text-align: left;">Total transpiration</td>
</tr>
<tr class="even">
<td style="text-align: left;">SoilMoist</td>
<td style="text-align: left;">Average Layer Soil Moisture</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SoilMoistFrac</td>
<td style="text-align: left;">Average Layer Fraction of Saturation</td>
</tr>
<tr class="even">
<td style="text-align: left;">SWE</td>
<td style="text-align: left;">Snow Water Equivalent</td>
</tr>
<tr class="odd">
<td style="text-align: left;">litter_mass_content_of_water</td>
<td style="text-align: left;">Average layer litter moisture</td>
</tr>
<tr class="even">
<td style="text-align: left;">year</td>
<td style="text-align: left;">Year</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="visualize-model-results" class="level1" data-number="15">
<h1 data-number="15"><span class="header-section-number">15</span> Visualize Model Results</h1>
<p>This section provides examples of how to create time series plots of different model variables. The examples cover various ecosystem processes including carbon fluxes, carbon pools, water variables, and structural variables like Leaf Area Index (LAI).</p>
<section id="plot-carbon-fluxes" class="level2" data-number="15.1">
<h2 data-number="15.1" class="anchored" data-anchor-id="plot-carbon-fluxes"><span class="header-section-number">15.1</span> Plot Carbon Fluxes</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Gross Primary Productivity (GPP) and Net Primary Productivity (NPP)</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_output<span class="sc">$</span>posix, model_output<span class="sc">$</span>GPP,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"green"</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Date"</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Carbon Flux (kg C m-2 s-1)"</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Carbon Fluxes Over Time — PEcAn"</span>, runid)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(model_output<span class="sc">$</span>posix, model_output<span class="sc">$</span>NPP, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"GPP"</span>, <span class="st">"NPP"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"green"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="uncertainty_files/figure-html/plot-carbon-fluxes-1.png" class="img-fluid figure-img" width="3000"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plot-carbon-pools" class="level2" data-number="15.2">
<h2 data-number="15.2" class="anchored" data-anchor-id="plot-carbon-pools"><span class="header-section-number">15.2</span> Plot Carbon Pools</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Total Live Biomass and Total Soil Carbon</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_output<span class="sc">$</span>posix, model_output<span class="sc">$</span>TotLivBiom,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"darkgreen"</span>,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Date"</span>,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Carbon Pool (kg C m-2)"</span>,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Carbon Pools Over Time — PEcAn"</span>, runid)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(model_output<span class="sc">$</span>posix, model_output<span class="sc">$</span>TotSoilCarb, <span class="at">col =</span> <span class="st">"brown"</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Total Live Biomass"</span>, <span class="st">"Total Soil Carbon"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"darkgreen"</span>, <span class="st">"brown"</span>), <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="uncertainty_files/figure-html/plot-carbon-pools-1.png" class="img-fluid figure-img" width="3000"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plot-water-variables" class="level2" data-number="15.3">
<h2 data-number="15.3" class="anchored" data-anchor-id="plot-water-variables"><span class="header-section-number">15.3</span> Plot Water Variables</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Soil Moisture and Snow Water Equivalent</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_output<span class="sc">$</span>posix, model_output<span class="sc">$</span>SoilMoist,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"blue"</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Date"</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Soil Moisture (kg m-2)"</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Soil Moisture Over Time — PEcAn"</span>, runid)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(model_output<span class="sc">$</span>posix, model_output<span class="sc">$</span>SWE, <span class="at">col =</span> <span class="st">"lightblue"</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Soil Moisture"</span>, <span class="st">"Snow Water Equivalent"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"lightblue"</span>), <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="uncertainty_files/figure-html/plot-water-variables-1.png" class="img-fluid figure-img" width="3000"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plot-lai-and-biomass" class="level2" data-number="15.4">
<h2 data-number="15.4" class="anchored" data-anchor-id="plot-lai-and-biomass"><span class="header-section-number">15.4</span> Plot LAI and Biomass</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Leaf Area Index (LAI) and Above Ground Wood</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_output<span class="sc">$</span>posix, model_output<span class="sc">$</span>LAI,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"darkgreen"</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Date"</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"LAI (m2 m-2)"</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Leaf Area Index Over Time — PEcAn"</span>, runid)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(model_output<span class="sc">$</span>posix, model_output<span class="sc">$</span>AbvGrndWood, <span class="at">col =</span> <span class="st">"brown"</span>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"LAI"</span>, <span class="st">"Above Ground Wood"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"darkgreen"</span>, <span class="st">"brown"</span>), <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="uncertainty_files/figure-html/plot-lai-biomass-1.png" class="img-fluid figure-img" width="3000"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level1" data-number="16">
<h1 data-number="16"><span class="header-section-number">16</span> Conclusion</h1>
<p>This notebook demonstrated how to set up, run, and analyze a PEcAn ecosystem model workflow programmatically. You can now modify parameters, try different models, or extend the analysis as needed.</p>
<p>Try editing the <code>pecan.xml</code> file. Give it a new name and update the <strong>settings_path</strong> variable at the beginning of this Demo to point to the new file. See how the changes affect the model output!</p>
</section>
<section id="further-exploration" class="level1" data-number="17">
<h1 data-number="17"><span class="header-section-number">17</span> Further Exploration</h1>
<p>The <a href="#demo-table">next set of tutorials</a> will focus on the process of data assimilation and parameter estimation. The next two steps are in “.Rmd” files which can be viewed online.</p>
<p><strong>Assimilation ‘by hand’</strong></p>
<p><a href="https://github.com/PecanProject/pecan/blob/main/documentation/tutorials/sensitivity/PEcAn_sensitivity_tutorial_v1.0.Rmd">Explore</a> how model error changes as a function of parameter value (i.e.&nbsp;data assimilation ‘by hand’)</p>
<p><strong>MCMC Concepts</strong> <a href="https://github.com/PecanProject/pecan/blob/main/documentation/tutorials/MCMC/MCMC_Concepts.Rmd">Explore</a> Bayesian MCMC concepts using the photosynthesis module</p>
<p><strong>More info about tools, analyses, and specific tasks…</strong></p>
<p>Additional information about specific tasks (adding sites, models, data; software updates; etc.) and analyses (e.g.&nbsp;data assimilation) can be found in the PEcAn <a href="https://pecanproject.github.io/pecan-documentation/">documentation</a></p>
<p>If you encounter a problem with PEcAn that’s not covered in the documentation, or if PEcAn is missing functionality you need, please search <a href="https://github.com/PecanProject/pecan/issues?q=">known bugs and issues</a>, submit a <a href="https://github.com/PecanProject/pecan/issues/new/choose">bug report</a>, or ask a question in our <a href="https://join.slack.com/t/pecanproject/shared_invite/enQtMzkyODUyMjQyNTgzLWEzOTM1ZjhmYWUxNzYwYzkxMWVlODAyZWQwYjliYzA0MDA0MjE4YmMyOTFhMjYyMjYzN2FjODE4N2Y4YWFhZmQ">chat room</a>.</p>
</section>
<section id="clean-up-workflow-output-optional" class="level1" data-number="18">
<h1 data-number="18"><span class="header-section-number">18</span> Clean Up Workflow Output (Optional)</h1>
<p>If you want to remove all files and directories created by this workflow and start fresh, you can run the following code. This will delete the entire output directory specified in your settings. <strong>Use with caution!</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">WARNING</span><span class="co">: This will permanently delete all workflow output files!</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment the line below to enable cleanup.</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># fs::dir_delete(settings$outdir)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="session-information" class="level1" data-number="19">
<h1 data-number="19"><span class="header-section-number">19</span> Session Information</h1>
<section id="pecan-package-versions." class="level3" data-number="19.0.1">
<h3 data-number="19.0.1" class="anchored" data-anchor-id="pecan-package-versions."><span class="header-section-number">19.0.1</span> PEcAn package versions.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>PEcAn.all<span class="sc">::</span><span class="fu">pecan_version</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> package               v1.9.0 installed  source              
 PEcAn.all             1.9.0  1.9.0.9000 local (/pecan/bas...
 PEcAn.allometry       1.7.4  1.7.4.9000 local (/pecan/mod...
 PEcAn.assim.batch     1.9.0  1.9.0.9000 local (/pecan/mod...
 PEcAn.BASGRA          1.8.1  1.8.1.9000 local (/pecan/mod...
 PEcAn.benchmark       1.7.4  1.7.4.9000 local (/pecan/mod...
 PEcAn.BIOCRO          1.7.4  1.7.5      local (/pecan/mod...
 PEcAn.CABLE           1.7.4  NA         NA                  
 PEcAn.CLM45           1.7.4  1.7.4.9000 local (/pecan/mod...
 PEcAn.DALEC           1.7.4  1.7.5      local (/pecan/mod...
 PEcAn.data.atmosphere 1.9.0  1.9.1      local (/pecan/mod...
 PEcAn.data.land       1.8.1  1.8.2      local (/pecan/mod...
 PEcAn.data.mining     1.7.4  NA         NA                  
 PEcAn.data.remote     1.9.0  1.9.1      local (/pecan/mod...
 PEcAn.DB              1.8.1  1.8.1.9000 local (/pecan/bas...
 PEcAn.dvmdostem       1.7.4  1.7.5      local (/pecan/mod...
 PEcAn.ED2             1.8.1  1.8.2      local (/pecan/mod...
 PEcAn.emulator        1.8.1  1.8.1.9000 local (/pecan/mod...
 PEcAn.FATES           1.8.0  1.8.1      local (/pecan/mod...
 PEcAn.GDAY            1.7.4  1.7.5      local (/pecan/mod...
 PEcAn.JULES           1.7.4  1.7.5      local (/pecan/mod...
 PEcAn.LDNDC           1.0.1  1.0.2      local (/pecan/mod...
 PEcAn.LINKAGES        1.7.4  1.7.5      local (/pecan/mod...
 PEcAn.logger          1.8.3  1.8.4      local (/pecan/bas...
 PEcAn.LPJGUESS        1.8.0  1.8.1      local (/pecan/mod...
 PEcAn.MA              1.7.4  1.7.4.9000 local (/pecan/mod...
 PEcAn.MAAT            1.7.4  1.7.5      local (/pecan/mod...
 PEcAn.MAESPA          1.7.4  1.7.5      local (/pecan/mod...
 PEcAn.ModelName       1.8.1  1.8.1.9000 local (/pecan/mod...
 PEcAn.photosynthesis  1.7.4  1.7.4.9000 local (/pecan/mod...
 PEcAn.PRELES          1.7.4  NA         NA                  
 PEcAn.priors          1.7.4  1.7.4.9000 local (/pecan/mod...
 PEcAn.qaqc            1.7.4  1.7.4.9000 local (/pecan/bas...
 PEcAn.remote          1.9.0  1.9.0.9000 local (/pecan/bas...
 PEcAn.RothC           &lt;NA&gt;   0.0.0.9000 local (/pecan/mod...
 PEcAn.settings        1.9.0  1.9.1      local (/pecan/bas...
 PEcAn.SIBCASA         0.0.2  0.0.3      local (/pecan/mod...
 PEcAn.SIPNET          1.9.0  1.9.1      local (/pecan/mod...
 PEcAn.STICS           1.8.1  1.8.2      local (/pecan/mod...
 PEcAn.uncertainty     1.8.1  1.8.2      local (/pecan/mod...
 PEcAn.utils           1.8.1  1.8.2      local (/pecan/bas...
 PEcAn.visualization   1.8.1  1.8.1.9000 local (/pecan/bas...
 PEcAn.workflow        1.9.0  1.9.0.9000 local (/pecan/bas...
 PEcAnAssimSequential  1.9.0  1.9.0.9000 local (/pecan/mod...
 PEcAnRTM              1.7.4  1.9.0.9000 local (/pecan/mod...</code></pre>
</div>
</div>
</section>
<section id="r-session-information" class="level3" data-number="19.0.2">
<h3 data-number="19.0.2" class="anchored" data-anchor-id="r-session-information"><span class="header-section-number">19.0.2</span> R session information:</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.3 (2025-02-28)
Platform: x86_64-pc-linux-gnu
Running under: Ubuntu 24.04.2 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

time zone: Etc/UTC
tzcode source: system (glibc)

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] PEcAn.SIPNET_1.9.1           PEcAn.all_1.9.0.9000        
 [3] PEcAn.workflow_1.9.0.9000    PEcAn.remote_1.9.0.9000     
 [5] PEcAn.benchmark_1.7.4.9000   PEcAn.priors_1.7.4.9000     
 [7] PEcAn.emulator_1.8.1.9000    PEcAn.assim.batch_1.9.0.9000
 [9] PEcAn.data.remote_1.9.1      PEcAn.data.land_1.8.2       
[11] PEcAn.data.atmosphere_1.9.1  PEcAn.uncertainty_1.8.2     
[13] PEcAn.utils_1.8.2            PEcAn.logger_1.8.4          
[15] PEcAn.MA_1.7.4.9000          PEcAn.settings_1.9.1        
[17] PEcAn.DB_1.8.1.9000         

loaded via a namespace (and not attached):
 [1] PEcAn.qaqc_1.7.4.9000           DBI_1.2.3                      
 [3] gridExtra_2.3                   PEcAn.allometry_1.7.4.9000     
 [5] rlang_1.1.5                     magrittr_2.0.3                 
 [7] furrr_0.3.1                     e1071_1.7-16                   
 [9] compiler_4.4.3                  vctrs_0.6.5                    
[11] stringr_1.5.1                   pkgconfig_2.0.3                
[13] PEcAn.MAESPA_1.7.5              fastmap_1.2.0                  
[15] PEcAn.ED2_1.8.2                 labeling_0.4.3                 
[17] PEcAn.dvmdostem_1.7.5           PEcAn.ModelName_1.8.1.9000     
[19] rmarkdown_2.29                  pracma_2.4.4                   
[21] sessioninfo_1.2.3               purrr_1.0.4                    
[23] xfun_0.52                       PEcAn.JULES_1.7.5              
[25] jsonlite_2.0.0                  PEcAn.LINKAGES_1.7.5           
[27] PEcAn.SIBCASA_0.0.3             parallel_4.4.3                 
[29] R6_2.6.1                        PEcAn.DALEC_1.7.5              
[31] stringi_1.8.7                   PEcAn.CLM45_1.7.4.9000         
[33] RPostgreSQL_0.7-8               parallelly_1.43.0              
[35] numDeriv_2016.8-1.1             lubridate_1.9.4                
[37] Rcpp_1.0.14                     iterators_1.0.14               
[39] knitr_1.50                      PEcAnAssimSequential_1.9.0.9000
[41] igraph_2.1.4                    rngWELL_0.10-10                
[43] timechange_0.3.0                tidyselect_1.2.1               
[45] abind_1.4-8                     yaml_2.3.10                    
[47] PEcAn.LPJGUESS_1.8.1            codetools_0.2-20               
[49] listenv_0.9.1                   lattice_0.22-6                 
[51] tibble_3.2.1                    withr_3.0.2                    
[53] coda_0.19-4.1                   evaluate_1.0.3                 
[55] future_1.34.0                   sf_1.0-20                      
[57] units_0.8-7                     proxy_0.4-27                   
[59] PEcAn.BASGRA_1.8.1.9000         pillar_1.10.2                  
[61] PEcAn.BIOCRO_1.7.5              KernSmooth_2.23-26             
[63] foreach_1.5.2                   PEcAn.RothC_0.0.0.9000         
[65] nimble_1.3.0                    ncdf4_1.24                     
[67] generics_0.1.3                  rprojroot_2.0.4                
[69] ggplot2_3.5.2                   munsell_0.5.1                  
[71] scales_1.3.0                    randtoolbox_2.0.5              
[73] globals_0.16.3                  PEcAn.STICS_1.8.2              
[75] PEcAn.MAAT_1.7.5                class_7.3-23                   
[77] glue_1.8.0                      tools_4.4.3                    
[79] data.table_1.17.0               XML_3.99-0.18                  
[81] grid_4.4.3                      PEcAn.visualization_1.8.1.9000 
[83] PEcAn.photosynthesis_1.7.4.9000 colorspace_2.1-1               
[85] cli_3.6.4                       PEcAnRTM_1.9.0.9000            
[87] dplyr_1.1.4                     PEcAn.GDAY_1.7.5               
[89] gtable_0.3.6                    PEcAn.FATES_1.8.1              
[91] digest_0.6.37                   classInt_0.4-11                
[93] PEcAn.LDNDC_1.0.2               rjson_0.2.23                   
[95] htmlwidgets_1.6.4               farver_2.1.2                   
[97] htmltools_0.5.8.1               lifecycle_1.0.4                
[99] here_1.0.1                     </code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>